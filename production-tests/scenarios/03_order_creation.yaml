name: "Order Creation & Management"
description: "Создание заказов (доставка/самовывоз), обновление статусов, трекинг"

environment:
  base_url: "https://figma-product-catalog-production.up.railway.app/api/v1"
  shop_id: 2
  test_user_phone: "+77777777777"
  test_user_password: "test123"

test_steps:
  # Step 1: Login
  - name: "Login to get token"
    endpoint: "/auth/login"
    method: "POST"
    body:
      phone: "{{test_user_phone}}"
      password: "{{test_user_password}}"
    assertions:
      - status_code: 200
      - response.access_token: exists
    save:
      token: "response.access_token"

  # Step 2: Get available products
  - name: "Get products for order"
    endpoint: "/products/"
    method: "GET"
    query_params:
      shop_id: 2
      limit: 1
      enabled_only: true
    assertions:
      - status_code: 200
      - response: is_array
    save:
      product_id: "response[0].id"
      product_price: "response[0].price"

  # Step 3: Create delivery order
  - name: "Create delivery order"
    endpoint: "/orders/with-items"
    method: "POST"
    headers:
      Authorization: "Bearer {{token}}"
    body:
      customerName: "Test Customer Production"
      phone: "77051234567"
      delivery_address: "ул. Тестовая 123, Алматы"
      delivery_date: "2025-10-10T14:00:00"
      scheduled_time: "14:00-16:00"
      delivery_type: "delivery"
      items:
        - product_id: "{{product_id}}"
          quantity: 1
          price: "{{product_price}}"
      notes: "Production test order - delivery"
    assertions:
      - status_code: [200, 201]
    save:
      delivery_order_id: "response.id"
      tracking_id: "response.tracking_id"

  # Step 4: Create pickup order
  - name: "Create pickup order"
    endpoint: "/orders/with-items"
    method: "POST"
    headers:
      Authorization: "Bearer {{token}}"
    body:
      customerName: "Test Customer Pickup"
      phone: "77051234568"
      delivery_type: "pickup"
      delivery_date: "2025-10-10T12:00:00"
      scheduled_time: "12:00"
      items:
        - product_id: "{{product_id}}"
          quantity: 1
          price: "{{product_price}}"
      notes: "Production test order - pickup"
    assertions:
      - status_code: [200, 201]
    save:
      pickup_order_id: "response.id"

  # Step 5: List orders
  - name: "List all orders"
    endpoint: "/orders/"
    method: "GET"
    headers:
      Authorization: "Bearer {{token}}"
    query_params:
      limit: 10
    assertions:
      - status_code: 200
      - response: is_array

  # Step 6: Get order details
  - name: "Get delivery order details"
    endpoint: "/orders/{{delivery_order_id}}"
    method: "GET"
    headers:
      Authorization: "Bearer {{token}}"
    assertions:
      - status_code: 200

  # Step 7: Update order status
  - name: "Update order status to accepted"
    endpoint: "/orders/{{delivery_order_id}}/status"
    method: "PATCH"
    headers:
      Authorization: "Bearer {{token}}"
    query_params:
      status: "accepted"
    body:
      notes: "Order accepted via production test"
    assertions:
      - status_code: 200

  # Step 8: Track order by tracking_id (public)
  - name: "Track order by tracking ID"
    endpoint: "/orders/by-tracking/{{tracking_id}}/status"
    method: "GET"
    assertions:
      - status_code: 200

  # Step 9: Track orders by phone - requires auth
  - name: "Track orders by customer phone"
    endpoint: "/orders/"
    method: "GET"
    headers:
      Authorization: "Bearer {{token}}"
    query_params:
      customer_phone: "77051234567"
      limit: 10
    assertions:
      - status_code: 200
      - response: is_array

success_criteria:
  - delivery_order_created: true
  - pickup_order_created: true
  - order_status_updated: true
  - tracking_works: true
