# Database Migrations

–≠—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –æ–∫—Ä—É–∂–µ–Ω–∏—è–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏.

‚ö†Ô∏è **–í–ê–ñ–ù–û**: –≠—Ç–∏ —Å–∫—Ä–∏–ø—Ç—ã –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞ –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –¥–∞–Ω–Ω—ã—Ö.

---

## üì¶ SQLite ‚Üí PostgreSQL Migration

### `migrate_sqlite_to_postgresql.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ SQLite –≤ production PostgreSQL.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**:
- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ SQLite
- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö SQLite ‚Üí PostgreSQL
- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤ PostgreSQL –Ω–∞ Railway
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç ID –∏ relationships

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```bash
# 1. Backup production –ë–î
pg_dump $DATABASE_URL > backup.sql

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
python3 migrations/migrate_sqlite_to_postgresql.py

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
python3 scripts/check_production_db.py
```

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞ (–¥–∞—Ç–∞: ~2025-08)

---

## üîÑ Phased Migrations

### `migrate_phase1.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ—ç—Ç–∞–ø–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü (—á–∞—Å—Ç—å 1).

**–ú–∏–≥—Ä–∏—Ä—É–µ—Ç**:
- Products (1-1000)
- Orders (1-500)
- Users (–≤—Å–µ)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```bash
python3 migrations/migrate_phase1.py
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã—Ö.

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞

---

## üî¢ Data Sync & Export

### `migrate_sync.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É development –∏ production.

**–§—É–Ω–∫—Ü–∏–∏**:
- –î–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ timestamp
- Dry-run mode –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```bash
# Dry run (—Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
python3 migrations/migrate_sync.py --dry-run

# –†–µ–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
python3 migrations/migrate_sync.py --from-dev-to-prod
```

**–°—Ç–∞—Ç—É—Å**: üîÑ –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏

---

### `export_to_postgres.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –≤ PostgreSQL.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```bash
# –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
python3 migrations/export_to_postgres.py --all

# –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
python3 migrations/export_to_postgres.py --tables products,orders
```

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞

---

### `import_to_render.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Render PostgreSQL (—Å—Ç–∞—Ä—ã–π —Ö–æ—Å—Ç–∏–Ω–≥).

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: Render –±—ã–ª –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ Railway. –°–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏.

**–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è –£—Å—Ç–∞—Ä–µ–ª (Render ‚Üí Railway)

---

## üìû Specialized Migrations

### `migrate_phone_numbers.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**:
- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç +77088888888 ‚Üí 77088888888
- –£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ—Ñ–∏—Å—ã
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞ (+7 7XX)

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ç–∞–±–ª–∏—Ü—ã**:
- `user` (phone)
- `order` (customer_phone, recipient_phone, sender_phone)
- `telegram_client` (phone)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```bash
python3 migrations/migrate_phone_numbers.py
```

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞ (–¥–∞—Ç–∞: 2025-09)

---

### `migrate_product_images.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ú–∏–≥—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ Cloudflare R2.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**:
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (Figma/–ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏)
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ Cloudflare R2 Storage
3. –û–±–Ω–æ–≤–ª—è–µ—Ç `product.image` –∏ `productimage.url`
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç mapping —Å—Ç–∞—Ä—ã—Ö ‚Üí –Ω–æ–≤—ã—Ö URL

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```bash
# –° –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –Ω–∞ –∫–∞–∂–¥—ã–π upload
python3 migrations/migrate_product_images.py

# Batch —Ä–µ–∂–∏–º
python3 migrations/migrate_product_images.py --batch
```

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞ (–¥–∞—Ç–∞: 2025-09)

---

## üîí Safety Guidelines

### –ü–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **Backup –ë–î**:
   ```bash
   # PostgreSQL
   pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql

   # SQLite
   cp figma_catalog.db figma_catalog_backup_$(date +%Y%m%d).db
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**:
   ```bash
   pip install -r requirements.txt
   ```

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö**:
   - –°–æ–∑–¥–∞—Ç—å test database
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ test
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å

4. **Dry-run –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ**:
   ```bash
   python3 migrations/script.py --dry-run
   ```

### –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π**:
   ```sql
   SELECT COUNT(*) FROM products;
   SELECT COUNT(*) FROM orders;
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å**:
   ```bash
   python3 scripts/check_production_db.py
   ```

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API**:
   ```bash
   cd backend
   ./quick_test.sh
   ```

---

## üìä Migration Log

| –î–∞—Ç–∞ | –ú–∏–≥—Ä–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ó–∞–ø–∏—Å–µ–π | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|------|----------|--------|---------|------------|
| 2025-08-15 | SQLite ‚Üí PostgreSQL | ‚úÖ –£—Å–ø–µ—à–Ω–æ | ~500 products, ~200 orders | –ù–∞—á–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è |
| 2025-09-01 | Phone normalization | ‚úÖ –£—Å–ø–µ—à–Ω–æ | 850 records updated | –£–±—Ä–∞–ª–∏ +7 –ø—Ä–µ—Ñ–∏–∫—Å |
| 2025-09-10 | Product images ‚Üí R2 | ‚úÖ –£—Å–ø–µ—à–Ω–æ | 450 images uploaded | Cloudflare R2 |

---

## üõ†Ô∏è Troubleshooting

### –û—à–∏–±–∫–∞: "relation already exists"
**–†–µ—à–µ–Ω–∏–µ**: –ë–î —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–∞–±–ª–∏—Ü—ã. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–∞ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è.

### –û—à–∏–±–∫–∞: "phone format invalid"
**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–ø—É—Å—Ç–∏—Ç—å `migrate_phone_numbers.py` –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏.

### –û—à–∏–±–∫–∞: "foreign key constraint"
**–†–µ—à–µ–Ω–∏–µ**: –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (users ‚Üí products ‚Üí orders).

---

## üìù Adding New Migration

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **–ò–º—è —Ñ–∞–π–ª–∞**: `migrate_<description>.py` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `migrate_add_shop_settings.py`)

2. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
   ```python
   """
   Migration: <–û–ø–∏—Å–∞–Ω–∏–µ>
   Date: YYYY-MM-DD
   Author: <–ò–º—è>

   Changes:
   - <–ò–∑–º–µ–Ω–µ–Ω–∏–µ 1>
   - <–ò–∑–º–µ–Ω–µ–Ω–∏–µ 2>
   """

   def migrate():
       # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
       pass

   def rollback():
       # –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
       pass

   if __name__ == "__main__":
       migrate()
   ```

3. **–û–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç README** —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

4. **–î–æ–±–∞–≤–∏—Ç—å –≤ Migration Log** –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 23 –æ–∫—Ç—è–±—Ä—è 2025
