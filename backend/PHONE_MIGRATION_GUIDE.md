# Phone Number Migration Guide

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç `+7XXXXXXXXXX`, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
- –ù–æ–º–µ—Ä–∞ –≤ —Å—Ç–∞—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (8XXXXXXXXXX, 7XXXXXXXXXX, –±–µ–∑ +)
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥—É–±–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–∞–Ω—É—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–º–∏ –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

## –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ –ë–î

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å unique constraints:**

1. **User.phone** - –≥–ª–æ–±–∞–ª—å–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ
   - –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏ `87015211545` –∏ `+77015211545` –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞–Ω—É—Ç –¥—É–±–ª—è–º–∏
   - Location: `backend/models/users.py:95`

2. **Client (phone + shop_id)** - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≤ —Ä–∞–º–∫–∞—Ö –º–∞–≥–∞–∑–∏–Ω–∞
   - –ü—Ä–æ–±–ª–µ–º–∞: –í –æ–¥–Ω–æ–º –º–∞–≥–∞–∑–∏–Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∫–ª–∏–µ–Ω—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –æ–¥–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
   - Location: `backend/models/users.py:62`

**–ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–Ω–µ—Ç unique constraints):**
- Order.phone, Order.recipient_phone, Order.sender_phone
- Shop.phone

## –†–µ—à–µ–Ω–∏–µ: –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `migrate_phone_numbers.py` –∫–æ—Ç–æ—Ä—ã–π:
1. ‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥—É–±–ª–∏ –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
2. ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç `+7XXXXXXXXXX`
3. ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º)
4. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç dry-run —Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–µ–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

```bash
cd backend
python3 migrate_phone_numbers.py --analyze-only
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç User —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –¥—É–±–ª–∏
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Client —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –¥—É–±–ª–∏ –≤ —Ä–∞–º–∫–∞—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Order –∏ Shop –Ω–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
- –ù–ï –≤–Ω–æ—Å–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
ANALYZING PHONE NUMBER DUPLICATES
==========================================

1. Checking User table (globally unique phone)...
   ‚ùå Found 2 duplicate phone numbers after normalization:
      +77015211545:
         - User #1 (–ò–≤–∞–Ω): 87015211545 ‚Üí +77015211545
         - User #5 (–ü–µ—Ç—Ä): +77015211545 ‚Üí +77015211545

2. Checking Client table (unique per shop)...
   ‚úÖ No duplicates found
```

### –®–∞–≥ 2: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π (dry-run)

```bash
python3 migrate_phone_numbers.py --dry-run
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫–∏–µ –Ω–æ–º–µ—Ä–∞ –±—É–¥—É—Ç –∏–∑–º–µ–Ω–µ–Ω—ã
- –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
MIGRATION MODE - Dry Run
==========================================

1. Migrating User table...
   User #1 (–ò–≤–∞–Ω): 87015211545 ‚Üí +77015211545
   User #3 (–ú–∞—Ä–∏—è): 7015211545 ‚Üí +77015211545
   Updated 2 users

2. Migrating Client table...
   Client #10 (Shop 8): 8 701 521 15 45 ‚Üí +77015211545
   Updated 1 clients

üìã Dry run complete. Would update 5 records total
```

### –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

‚ö†Ô∏è **–í–ê–ñ–ù–û:** –°–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥—É–±–ª–µ–π –Ω–µ—Ç!

```bash
python3 migrate_phone_numbers.py
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ –Ω–æ–º–µ—Ä–∞
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î
- –î–µ–ª–∞–µ—Ç COMMIT –∏–ª–∏ ROLLBACK –ø—Ä–∏ –æ—à–∏–±–∫–µ

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–µ–π

–ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–∞—Ö–æ–¥–∏—Ç –¥—É–±–ª–∏, –º–∏–≥—Ä–∞—Ü–∏—è **–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è** —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º:

```
‚ö†Ô∏è  CRITICAL: Duplicate phone numbers found!

You must manually resolve these duplicates before running migration:
1. Decide which records to keep
2. Merge or delete duplicate records
3. Re-run this script
```

### –ö–∞–∫ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –¥—É–±–ª—è–º–∏:

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π (User)
```sql
-- –ù–∞–π—Ç–∏ –¥—É–±–ª–∏
SELECT phone, COUNT(*) as count
FROM "user"
GROUP BY phone
HAVING COUNT(*) > 1;

-- –í—Ä—É—á–Ω—É—é —Ä–µ—à–∏—Ç—å –∫–∞–∫—É—é –∑–∞–ø–∏—Å—å –æ—Å—Ç–∞–≤–∏—Ç—å
-- –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (orders, shop ownership)
-- –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç
DELETE FROM "user" WHERE id = 123;
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ (–µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–∑–Ω—ã–µ –ª—é–¥–∏)
```sql
-- –ï—Å–ª–∏ –æ–¥–∏–Ω –Ω–æ–º–µ—Ä –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¥–≤—É–º —Ä–∞–∑–Ω—ã–º –ª—é–¥—è–º
UPDATE "user"
SET phone = '+77012345678'  -- –†–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –≤—Ç–æ—Ä–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞
WHERE id = 123;
```

#### –í–∞—Ä–∏–∞–Ω—Ç 3: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ (Client)
```sql
-- –ù–∞–π—Ç–∏ –¥—É–±–ª–∏ –≤ —Ä–∞–º–∫–∞—Ö –º–∞–≥–∞–∑–∏–Ω–∞
SELECT shop_id, phone, COUNT(*) as count
FROM client
GROUP BY shop_id, phone
HAVING COUNT(*) > 1;

-- –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∑–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å
-- –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç
DELETE FROM client WHERE id = 456;
```

## Production Deployment

### Railway (Production)

```bash
# 1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ production –æ–∫—Ä—É–∂–µ–Ω–∏—é
railway link

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑
railway run python3 migrate_phone_numbers.py --analyze-only

# 3. –ï—Å–ª–∏ –¥—É–±–ª–µ–π –Ω–µ—Ç, –∑–∞–ø—É—Å—Ç–∏—Ç—å dry-run
railway run python3 migrate_phone_numbers.py --dry-run

# 4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
railway run python3 migrate_phone_numbers.py
```

### Local Development

```bash
# 1. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ DATABASE_URL –≤ .env
echo $DATABASE_URL

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑
python3 migrate_phone_numbers.py --analyze-only

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
python3 migrate_phone_numbers.py
```

## –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:

1. ‚úÖ –í—Å–µ –Ω–æ–º–µ—Ä–∞ –≤ –ë–î –±—É–¥—É—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ `+7XXXXXXXXXX`
2. ‚úÖ –ù–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å—Å—è (Pydantic validators)
3. ‚úÖ API –±—É–¥–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ `+7XXXXXXXXXX`

## –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –Ω–æ–º–µ—Ä–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å +7
SELECT COUNT(*) as invalid_phones
FROM "user"
WHERE phone NOT LIKE '+7__________';

-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
```

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤
SELECT COUNT(*) as invalid_phones
FROM client
WHERE phone NOT LIKE '+7__________';

-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
```

## Rollback Plan

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ backup
railway backup restore <backup-id>
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL:
```sql
-- –û—Ç–∫–∞—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å backup —Ç–∞–±–ª–∏—Ü—ã)
UPDATE "user" u
SET phone = b.phone
FROM user_backup b
WHERE u.id = b.id;
```

## Checklist –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π

- [ ] –°–æ–∑–¥–∞–Ω backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] –ó–∞–ø—É—â–µ–Ω `--analyze-only` –∏ –¥—É–±–ª–µ–π –Ω–µ—Ç
- [ ] –ó–∞–ø—É—â–µ–Ω `--dry-run` –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] –ö–æ–º–∞–Ω–¥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∞ –æ downtime (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω rollback plan

## –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

**Q: –ù—É–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏?**
A: –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production. –°–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä—ã–π (< 1 –º–∏–Ω—É—Ç—ã –¥–ª—è —Ç—ã—Å—è—á –∑–∞–ø–∏—Å–µ–π).

**Q: –ß—Ç–æ –µ—Å–ª–∏ –≤ –ë–î –µ—Å—Ç—å –Ω–æ–º–µ—Ä–∞ –Ω–µ –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞?**
A: –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç –∏—Ö —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º. –ù—É–∂–Ω–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Ä—É—á–Ω—É—é.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑?**
A: –î–∞, —Å–∫—Ä–∏–ø—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π - –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ —Å–ª–æ–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ.

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö: —Å–æ–∑–¥–∞—Ç—å issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∫–æ–º–∞–Ω–¥–æ–π.
