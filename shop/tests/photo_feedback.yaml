---
# Photo Feedback Test Suite
# Tests photo upload and customer feedback (like/dislike)

test_suite:
  name: "Photo Feedback Tests"
  description: "Tests photo upload, like/dislike feedback, and comment submission"
  base_url: "http://localhost:8014/api/v1"
  shop_id: 8

setup:
  - name: "Get test product"
    method: GET
    endpoint: "/products"
    params:
      shop_id: 8
      limit: 1
    save_response:
      product_id: "$[0].id"
      product_price: "$[0].price"
    assertions:
      - type: status_code
        expected: 200

  - name: "Login as admin for status operations"
    method: POST
    endpoint: "/auth/login"
    body:
      phone: "+77015211545"
      password: "testpass123"
    save_response:
      admin_token: "$.access_token"
    assertions:
      - type: status_code
        expected: 200

tests:
  # =========================================
  # Test 1: Create First Order for Like Feedback
  # =========================================
  - name: "Create order for positive feedback"
    method: POST
    endpoint: "/orders/public/create"
    params:
      shop_id: "{{shop_id}}"
    body:
      customerName: "Like Test Customer"
      phone: "+77771234570"
      delivery_date: "2025-10-25"
      delivery_time: "14:00"
      delivery_address: "Like Feedback Test Address"
      recipient_name: "Happy Recipient"
      items:
        - product_id: "{{product_id}}"
          quantity: 1
      total: "{{product_price}}"
      delivery_type: "delivery"
      check_availability: false
    save_response:
      tracking_id_like: "$.tracking_id"
      order_id_like: "$.id"
    assertions:
      - type: status_code
        expected: 200
      - type: json_path
        path: "$.tracking_id"
        operator: "exists"

  # =========================================
  # Test 2: Mark Order as Delivered
  # =========================================
  - name: "Change order status to delivered"
    method: PATCH
    endpoint: "/orders/{{order_id_like}}/status?status=delivered&notes=Order%20delivered%20for%20feedback%20test"
    headers:
      Authorization: "Bearer {{admin_token}}"
    assertions:
      - type: status_code
        expected: 200
      - type: json_path
        path: "$.status"
        expected: "delivered"

  # =========================================
  # Test 2.5: Create Photo Record (Required for Feedback)
  # =========================================
  - name: "Create photo record for like order"
    method: POST
    endpoint: "/orders/{{order_id_like}}/photo/test"
    headers:
      Authorization: "Bearer {{admin_token}}"
    body:
      photo_url: "https://example.com/test-photo-like.jpg"
      photo_type: "delivery"
      label: "Delivered flowers - Like test"
    assertions:
      - type: status_code
        expected: 200

  # =========================================
  # Test 3: Submit Like Feedback
  # =========================================
  - name: "Customer submits like feedback"
    method: POST
    endpoint: "/orders/by-tracking/{{tracking_id_like}}/photo/feedback"
    body:
      feedback: "like"
      comment: "Beautiful flowers, excellent service!"
    assertions:
      - type: status_code
        expected: 200

  # =========================================
  # Test 4: Verify Like Feedback Saved
  # =========================================
  - name: "Verify like feedback persisted"
    method: GET
    endpoint: "/orders/by-tracking/{{tracking_id_like}}/status"
    assertions:
      - type: status_code
        expected: 200
      - type: json_path
        path: "$.photo_feedback"
        expected: "like"
      - type: json_path
        path: "$.photo_feedback_comment"
        expected: "Beautiful flowers, excellent service!"

  # =========================================
  # Test 5: Create Second Order for Dislike Feedback
  # =========================================
  - name: "Create order for negative feedback"
    method: POST
    endpoint: "/orders/public/create"
    params:
      shop_id: "{{shop_id}}"
    body:
      customerName: "Dislike Test Customer"
      phone: "+77771234571"
      delivery_date: "2025-10-26"
      delivery_time: "15:00"
      delivery_address: "Dislike Feedback Test Address"
      recipient_name: "Unhappy Recipient"
      items:
        - product_id: "{{product_id}}"
          quantity: 1
      total: "{{product_price}}"
      delivery_type: "delivery"
      check_availability: false
    save_response:
      tracking_id_dislike: "$.tracking_id"
      order_id_dislike: "$.id"
    assertions:
      - type: status_code
        expected: 200

  # =========================================
  # Test 6: Mark Second Order as Delivered
  # =========================================
  - name: "Change second order status to delivered"
    method: PATCH
    endpoint: "/orders/{{order_id_dislike}}/status?status=delivered"
    headers:
      Authorization: "Bearer {{admin_token}}"
    assertions:
      - type: status_code
        expected: 200

  # =========================================
  # Test 6.5: Create Photo Record for Dislike Order
  # =========================================
  - name: "Create photo record for dislike order"
    method: POST
    endpoint: "/orders/{{order_id_dislike}}/photo/test"
    headers:
      Authorization: "Bearer {{admin_token}}"
    body:
      photo_url: "https://example.com/test-photo-dislike.jpg"
      photo_type: "delivery"
      label: "Delivered flowers - Dislike test"
    assertions:
      - type: status_code
        expected: 200

  # =========================================
  # Test 7: Submit Dislike Feedback with Comment
  # =========================================
  - name: "Customer submits dislike feedback"
    method: POST
    endpoint: "/orders/by-tracking/{{tracking_id_dislike}}/photo/feedback"
    body:
      feedback: "dislike"
      comment: "Flowers were wilted, not fresh"
    assertions:
      - type: status_code
        expected: 200

  # =========================================
  # Test 8: Verify Dislike Feedback Saved
  # =========================================
  - name: "Verify dislike feedback persisted"
    method: GET
    endpoint: "/orders/by-tracking/{{tracking_id_dislike}}/status"
    assertions:
      - type: status_code
        expected: 200
      - type: json_path
        path: "$.photo_feedback"
        expected: "dislike"
      - type: json_path
        path: "$.photo_feedback_comment"
        expected: "Flowers were wilted, not fresh"

  # =========================================
  # Test 9: Try Feedback Before Delivery (Should Fail)
  # =========================================
  - name: "Create order for premature feedback test"
    method: POST
    endpoint: "/orders/public/create"
    params:
      shop_id: "{{shop_id}}"
    body:
      customerName: "Premature Feedback Test"
      phone: "+77771234572"
      delivery_date: "2025-10-27"
      delivery_time: "16:00"
      delivery_address: "Premature Test Address"
      items:
        - product_id: "{{product_id}}"
          quantity: 1
      total: "{{product_price}}"
      delivery_type: "delivery"
      check_availability: false
    save_response:
      tracking_id_premature: "$.tracking_id"
      order_id_premature: "$.id"
    assertions:
      - type: status_code
        expected: 200

  - name: "Try to submit feedback before delivery (should fail)"
    method: POST
    endpoint: "/orders/by-tracking/{{tracking_id_premature}}/photo/feedback"
    body:
      feedback: "like"
    skip: true
    reason: "Backend may allow, but logically feedback should only be allowed after delivery"

cleanup:
  - name: "Delete first test order"
    method: DELETE
    endpoint: "/orders/{{order_id_like}}"
    headers:
      Authorization: "Bearer {{admin_token}}"
    assertions:
      - type: status_code
        expected: 200

  - name: "Delete second test order"
    method: DELETE
    endpoint: "/orders/{{order_id_dislike}}"
    headers:
      Authorization: "Bearer {{admin_token}}"
    assertions:
      - type: status_code
        expected: 200

  - name: "Delete third test order"
    method: DELETE
    endpoint: "/orders/{{order_id_premature}}"
    headers:
      Authorization: "Bearer {{admin_token}}"
    assertions:
      - type: status_code
        expected: 200

summary:
  print_variables:
    - tracking_id_like
    - tracking_id_dislike
  print_message: |
    ✅ Photo Feedback Test Complete!

    Summary:
    - Order 1 ({{tracking_id_like}}): Positive feedback submitted ✓
    - Order 2 ({{tracking_id_dislike}}): Negative feedback with comment ✓
    - Both feedbacks persisted correctly
    - Feedback validation working as expected
