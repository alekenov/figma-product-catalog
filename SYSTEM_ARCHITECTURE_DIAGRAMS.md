# System Architecture - Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¡Ñ…ĞµĞ¼Ñ‹

**Ğ”Ğ°Ñ‚Ğ°**: 2025-10-24
**Ğ¯Ğ·Ñ‹Ğº**: Ğ ÑƒÑÑĞºĞ¸Ğ¹ Ñ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°Ğ¼Ğ¸

---

## 1. ĞĞ‘Ğ©ĞĞ¯ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸŒ PRODUCTION CVETY.KZ                              â”‚
â”‚                    (Kazakhstan Flower Delivery Service)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CUSTOMER CHANNELS      â”‚         â”‚   ADMIN CHANNELS     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                          â”‚         â”‚                      â”‚
â”‚  ğŸ“± Telegram Bot         â”‚         â”‚  ğŸ’» Admin Panel      â”‚
â”‚     (customer-bot)       â”‚         â”‚     (Frontend React) â”‚
â”‚                          â”‚         â”‚  https://frontend-.. â”‚
â”‚  ğŸŒ Web Shop             â”‚         â”‚                      â”‚
â”‚     (shop/ React)        â”‚         â”‚  ğŸ‘¨â€ğŸ’¼ Admin Users     â”‚
â”‚  https://shop.cvety.kz   â”‚         â”‚     (+77015211545)   â”‚
â”‚                          â”‚         â”‚                      â”‚
â”‚  ğŸ’¬ WhatsApp (API)       â”‚         â”‚  ğŸ“Š Telegram Admin   â”‚
â”‚  (future)                â”‚         â”‚     Bot              â”‚
â”‚                          â”‚         â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                      â”‚
         â”‚  ORDERS                              â”‚  UPDATES
         â”‚  TRACKING                            â”‚  PRODUCTS
         â”‚  PAYMENTS                            â”‚  INVENTORY
         â”‚                                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           RAILWAY BACKEND API                     â”‚
        â”‚    https://figma-product-catalog-production..    â”‚
        â”‚                                                   â”‚
        â”‚  FastAPI (Python 3.10)  â€¢  147 Endpoints        â”‚
        â”‚  Port: 8080  â€¢  Auto-scaling                    â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                                   â”‚
        â”‚  API Routes:                                      â”‚
        â”‚  â”œâ”€ /api/v1/products/     (Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹)              â”‚
        â”‚  â”œâ”€ /api/v1/orders/       (Ğ·Ğ°ĞºĞ°Ğ·Ñ‹)              â”‚
        â”‚  â”œâ”€ /api/v1/auth/         (Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)         â”‚
        â”‚  â”œâ”€ /api/v1/delivery/     (Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ°)            â”‚
        â”‚  â”œâ”€ /api/v1/chats/        (AI Ñ‡Ğ°Ñ‚Ñ‹)             â”‚
        â”‚  â”œâ”€ /api/v1/webhooks/     (Bitrix sync) â­      â”‚
        â”‚  â”œâ”€ /api/v1/warehouse/    (Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ)           â”‚
        â”‚  â”œâ”€ /api/v1/kaspi/        (Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ¸)             â”‚
        â”‚  â””â”€ /health, /ready, /metrics                   â”‚
        â”‚                                                   â”‚
        â”‚  Services:                                        â”‚
        â”‚  â”œâ”€ BitrixSyncService (product sync)             â”‚
        â”‚  â”œâ”€ EmbeddingClient (AI search)                  â”‚
        â”‚  â”œâ”€ KaspiPollingService (payments)               â”‚
        â”‚  â””â”€ LoggingService (structured logs)             â”‚
        â”‚                                                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚               â”‚          â”‚
                   â–¼               â–¼          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  PostgreSQL DB   â”‚  â”‚Cloudflare  â”‚ Embedding Service
        â”‚  (Railway)       â”‚  â”‚ R2 Storage â”‚ (AI vectors)
        â”‚                  â”‚  â”‚ (Images)   â”‚
        â”‚ âœ… Healthy       â”‚  â”‚            â”‚
        â”‚                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ Tables:          â”‚
        â”‚ â”œâ”€ shop          â”‚
        â”‚ â”œâ”€ product       â”‚
        â”‚ â”œâ”€ order         â”‚
        â”‚ â”œâ”€ order_history â”‚
        â”‚ â”œâ”€ warehouse_itemâ”‚
        â”‚ â”œâ”€ client_profileâ”‚
        â”‚ â””â”€ (28 tables)   â”‚
        â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PRODUCTION BITRIX (185.125.90.141)                     â”‚
â”‚   Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° - ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² & CRM Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²         â”‚
â”‚                                                          â”‚
â”‚   MySQL  â€¢  PHP  â€¢  Custom CRM                          â”‚
â”‚                                                          â”‚
â”‚   Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ:                                                â”‚
â”‚   â”œâ”€ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ (Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹)                                  â”‚
â”‚   â”œâ”€ Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ (Ğ¾Ñ‚ Ñ„Ğ»Ğ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²)                              â”‚
â”‚   â”œâ”€ ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹                                            â”‚
â”‚   â””â”€ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ                                             â”‚
â”‚                                                          â”‚
â”‚   ğŸ“Œ Synced: â­ Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ â†” Railway                         â”‚
â”‚           â­ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ â†” Railway                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Ğ¡Ğ˜ĞĞ¥Ğ ĞĞĞ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ—ĞĞšĞĞ—ĞĞ’: Bitrix â†’ Railway (Webhook)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FLORIST Ğ’ BITRIX CRM ĞœĞ•ĞĞ¯Ğ•Ğ¢ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ—ĞĞšĞĞ—Ğ                             â”‚
â”‚  (ĞĞ¾Ğ¼ĞµÑ€ Ğ·Ğ°ĞºĞ°Ğ·Ğ°: #123456)                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  OLD STATUS: N (ĞĞ¾Ğ²Ñ‹Ğ¹)              â”‚
        â”‚  NEW STATUS: AP (ĞŸÑ€Ğ¸Ğ½ÑÑ‚ Ñ„Ğ»Ğ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ¼)  â”‚
        â”‚                                     â”‚
        â”‚  ğŸ”” Bitrix event triggered:         â”‚
        â”‚     OnSaleStatusOrderChange         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  EVENT HANDLER (PHP)                       â”‚
     â”‚  /home/bitrix/www/local/php_interface/     â”‚
     â”‚  init.php:818-822                          â”‚
     â”‚                                            â”‚
     â”‚  Registers:                                â”‚
     â”‚  CvetyOrderStatusWebhook::onOrderStatusChg â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  HTTP POST REQUEST TO RAILWAY                â”‚
     â”‚                                               â”‚
     â”‚  POST /api/v1/webhooks/order-status-sync     â”‚
     â”‚  Host: figma-product-catalog-production...   â”‚
     â”‚  Content-Type: application/json              â”‚
     â”‚  X-Webhook-Secret: cvety-webhook-2025-...    â”‚
     â”‚                                               â”‚
     â”‚  Body: {                                      â”‚
     â”‚    "order_id": 123456,      â† Bitrix ID      â”‚
     â”‚    "status": "AP",          â† Bitrix code     â”‚
     â”‚    "changed_by_id": 42,     â† Admin ID        â”‚
     â”‚    "notes": "ĞŸÑ€Ğ¸Ğ½ÑÑ‚ Ñ„Ğ»Ğ¾Ñ€Ğ¸ÑÑ‚"                â”‚
     â”‚  }                                            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ (Network: ~50-100ms)
                       â”‚
                       â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  RAILWAY WEBHOOK ENDPOINT                    â”‚
     â”‚  backend/api/webhooks.py:442-530            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                              â”‚
     â”‚  1ï¸âƒ£  AUTHENTICATE                           â”‚
     â”‚     X-Webhook-Secret: cvety-webhook...      â”‚
     â”‚     If not match â†’ HTTP 401 âŒ               â”‚
     â”‚                                              â”‚
     â”‚     âœ… Secret valid                         â”‚
     â”‚                                              â”‚
     â”‚  2ï¸âƒ£  PARSE REQUEST                          â”‚
     â”‚     order_id = 123456                        â”‚
     â”‚     status = "AP"                            â”‚
     â”‚                                              â”‚
     â”‚  3ï¸âƒ£  FIND ORDER IN DATABASE                 â”‚
     â”‚     SELECT * FROM "order"                    â”‚
     â”‚     WHERE bitrix_order_id = 123456           â”‚
     â”‚     AND shop_id = 17008  (production only!)  â”‚
     â”‚                                              â”‚
     â”‚     âœ… Found: order_id=789                   â”‚
     â”‚                                              â”‚
     â”‚  4ï¸âƒ£  MAP STATUS                             â”‚
     â”‚     "AP" (Bitrix) â†’ ACCEPTED (Railway)       â”‚
     â”‚                                              â”‚
     â”‚     Mapping Table:                           â”‚
     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚     â”‚ Bitrix   â”‚ Railway          â”‚          â”‚
     â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
     â”‚     â”‚ N        â”‚ NEW              â”‚          â”‚
     â”‚     â”‚ PD       â”‚ PAID             â”‚          â”‚
     â”‚     â”‚ AP       â”‚ ACCEPTED         â”‚ â† Here   â”‚
     â”‚     â”‚ CO       â”‚ ASSEMBLED        â”‚          â”‚
     â”‚     â”‚ DE       â”‚ IN_DELIVERY      â”‚          â”‚
     â”‚     â”‚ F        â”‚ DELIVERED        â”‚          â”‚
     â”‚     â”‚ RF/UN    â”‚ CANCELLED        â”‚          â”‚
     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚                                              â”‚
     â”‚  5ï¸âƒ£  UPDATE ORDER                           â”‚
     â”‚     UPDATE "order"                           â”‚
     â”‚     SET status = 'accepted'                  â”‚
     â”‚     WHERE id = 789                           â”‚
     â”‚                                              â”‚
     â”‚     âœ… Updated: 1 row                        â”‚
     â”‚                                              â”‚
     â”‚  6ï¸âƒ£  RECORD HISTORY                         â”‚
     â”‚     INSERT INTO order_history (              â”‚
     â”‚       order_id=789,                          â”‚
     â”‚       old_status='new',                      â”‚
     â”‚       new_status='accepted',                 â”‚
     â”‚       changed_by='bitrix',   â† Important!    â”‚
     â”‚       notes='...',                           â”‚
     â”‚       created_at=NOW()                       â”‚
     â”‚     )                                        â”‚
     â”‚                                              â”‚
     â”‚     âœ… History recorded                      â”‚
     â”‚                                              â”‚
     â”‚  7ï¸âƒ£  RETURN RESPONSE                        â”‚
     â”‚     HTTP 200 OK                              â”‚
     â”‚     {                                        â”‚
     â”‚       "status": "success",                   â”‚
     â”‚       "order_id": 789,                       â”‚
     â”‚       "railway_order_id": 789,               â”‚
     â”‚       "old_status": "new",                   â”‚
     â”‚       "new_status": "accepted",              â”‚
     â”‚       "history_recorded": true               â”‚
     â”‚     }                                        â”‚
     â”‚                                              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  PostgreSQL DATABASE              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                  â”‚
     â”‚  "order" table:                  â”‚
     â”‚  id: 789                         â”‚
     â”‚  tracking_id: "ABC123D9"         â”‚
     â”‚  bitrix_order_id: 123456 â† Added â”‚
     â”‚  status: "accepted" â† Updated!   â”‚
     â”‚  shop_id: 17008                  â”‚
     â”‚  ...other fields...              â”‚
     â”‚                                  â”‚
     â”‚  "order_history" table:          â”‚
     â”‚  id: 5241                        â”‚
     â”‚  order_id: 789                   â”‚
     â”‚  old_status: "new"               â”‚
     â”‚  new_status: "accepted"          â”‚
     â”‚  changed_by: "bitrix" â† Source   â”‚
     â”‚  timestamp: 2025-10-24 14:50:00  â”‚
     â”‚                                  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  âœ… SUCCESS!                      â”‚
     â”‚                                  â”‚
     â”‚  Customer Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ     â”‚
     â”‚  Ğ² Railway (Shop Frontend)       â”‚
     â”‚                                  â”‚
     â”‚  Admin Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ²          â”‚
     â”‚  Admin Dashboard (Frontend)      â”‚
     â”‚                                  â”‚
     â”‚  Ğ’ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ñ‹!   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Ğ¡Ğ˜ĞĞ¥Ğ ĞĞĞ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ¢ĞĞ’ĞĞ ĞĞ’: Railway â†” Bitrix (Bidirectional)

```
Ğ¡Ğ¦Ğ•ĞĞĞ Ğ˜Ğ™ 1: ADMIN ĞĞ‘ĞĞĞ’Ğ›Ğ¯Ğ•Ğ¢ Ğ¢ĞĞ’ĞĞ  Ğ’ RAILWAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚        â”‚
â”‚  "Update Product"      â”‚
â”‚  Ğ² Admin Panel         â”‚
â”‚  (Frontend React)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PUT /api/v1/products/668826               â”‚
â”‚  Headers: Authorization: Bearer $JWT_TOKEN â”‚
â”‚  Body: {                                   â”‚
â”‚    "name": "Ğ‘ÑƒĞºĞµÑ‚ Rosa Deluxe",            â”‚
â”‚    "price": 500000,    â† 5000 tenge Ğ² â‚¸  â”‚
â”‚    "description": "ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼ Ğ±ÑƒĞºĞµÑ‚",         â”‚
â”‚    "enabled": true                         â”‚
â”‚  }                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAILWAY BACKEND                          â”‚
â”‚  api/products/router.py:update_product()  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                           â”‚
â”‚  1. âœ… Verify JWT token                  â”‚
â”‚     shop_id from JWT = 17008 (production) â”‚
â”‚                                           â”‚
â”‚  2. âœ… Validate input                    â”‚
â”‚     Price: 500000 (valid kopecks)        â”‚
â”‚                                           â”‚
â”‚  3. âœ… Update PostgreSQL                 â”‚
â”‚     UPDATE product                        â”‚
â”‚     SET name='Ğ‘ÑƒĞºĞµÑ‚ Rosa Deluxe',        â”‚
â”‚         price=500000,                     â”‚
â”‚         description='ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼ Ğ±ÑƒĞºĞµÑ‚',      â”‚
â”‚         enabled=true                      â”‚
â”‚     WHERE id=668826                       â”‚
â”‚     AND shop_id=17008                     â”‚
â”‚                                           â”‚
â”‚  4. â­ CALL BITRIX SYNC SERVICE           â”‚
â”‚     BitrixSyncService.sync_product_...()  â”‚
â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BitrixSyncService                           â”‚
â”‚  backend/services/bitrix_sync_service.py     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  1. FORMAT DATA FOR BITRIX                  â”‚
â”‚     price_kopecks=500000 â†’ "5 000 â‚¸"        â”‚
â”‚                                              â”‚
â”‚     payload = {                              â”‚
â”‚       "name": "Ğ‘ÑƒĞºĞµÑ‚ Rosa Deluxe",          â”‚
â”‚       "price": "5 000 â‚¸",                   â”‚
â”‚       "image": "https://cloudflare...",     â”‚
â”‚       "description": "ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼ Ğ±ÑƒĞºĞµÑ‚",       â”‚
â”‚       "enabled": "Y"                        â”‚
â”‚     }                                        â”‚
â”‚                                              â”‚
â”‚  2. SEND HTTP PUT TO BITRIX API              â”‚
â”‚     PUT https://cvety.kz/api/v2/            â”‚
â”‚         products/update-from-railway/668826 â”‚
â”‚                                              â”‚
â”‚     Headers:                                 â”‚
â”‚       Authorization: Bearer $RAILWAY_TOKEN  â”‚
â”‚       Content-Type: application/json         â”‚
â”‚                                              â”‚
â”‚     Body: {...payload...}                   â”‚
â”‚                                              â”‚
â”‚     Timeout: 30 seconds                      â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (Network request ~100-200ms)
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BITRIX API ENDPOINT (PHP)                   â”‚
â”‚  /api/v2/products/update-from-railway/       â”‚
â”‚  185.125.90.141:/home/bitrix/www/            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  1. âœ… VERIFY BEARER TOKEN                  â”‚
â”‚     Authorization: Bearer $RAILWAY_TOKEN    â”‚
â”‚     Check if token matches env variable     â”‚
â”‚     If not â†’ HTTP 401 âŒ                    â”‚
â”‚                                              â”‚
â”‚  2. âœ… PARSE JSON PAYLOAD                   â”‚
â”‚     name, price, image, description, etc    â”‚
â”‚                                              â”‚
â”‚  3. âœ… DOWNLOAD IMAGE (if provided)         â”‚
â”‚     From Cloudflare R2 URL                  â”‚
â”‚     Save to Bitrix PREVIEW_PICTURE field    â”‚
â”‚                                              â”‚
â”‚  4. âœ… UPDATE BITRIX PRODUCT                â”‚
â”‚     SQL UPDATE:                              â”‚
â”‚       NAME = "Ğ‘ÑƒĞºĞµÑ‚ Rosa Deluxe"            â”‚
â”‚       PRICE = 500000 (in Bitrix currency)   â”‚
â”‚       PREVIEW_PICTURE = image file ID       â”‚
â”‚       DETAIL_TEXT = "ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼ Ğ±ÑƒĞºĞµÑ‚"         â”‚
â”‚       ACTIVE = "Y"                          â”‚
â”‚                                              â”‚
â”‚  5. âœ… RETURN HTTP 200                      â”‚
â”‚     {                                        â”‚
â”‚       "status": "success",                   â”‚
â”‚       "product_id": 668826,                  â”‚
â”‚       "updated_at": "2025-10-24T14:50:00"   â”‚
â”‚     }                                        â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BITRIX CRM (MySQL)                          â”‚
â”‚                                              â”‚
â”‚  b_iblock_element table:                    â”‚
â”‚  ID: 668826                                  â”‚
â”‚  NAME: "Ğ‘ÑƒĞºĞµÑ‚ Rosa Deluxe" âœ… Updated       â”‚
â”‚  PREVIEW_PICTURE: 12345 (image file)        â”‚
â”‚  DETAIL_TEXT: "ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼ Ğ±ÑƒĞºĞµÑ‚"              â”‚
â”‚                                              â”‚
â”‚  b_catalog_product table:                   â”‚
â”‚  PRODUCT_ID: 668826                         â”‚
â”‚  PRICE: 500000 âœ… Updated                   â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… SYNC COMPLETE!                          â”‚
â”‚                                              â”‚
â”‚  2-way sync successful:                     â”‚
â”‚  Railway <â†’ Bitrix                          â”‚
â”‚                                              â”‚
â”‚  Timeline:                                   â”‚
â”‚  â”œâ”€ API request: <50ms                     â”‚
â”‚  â”œâ”€ DB update: <50ms                       â”‚
â”‚  â”œâ”€ Network to Bitrix: ~100-200ms          â”‚
â”‚  â”œâ”€ Bitrix processing: ~100-300ms          â”‚
â”‚  â””â”€ Total: ~400-500ms âœ… Fast!              â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. DATA FLOW Ğ”Ğ˜ĞĞ“Ğ ĞĞœĞœĞ (ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°)

```
                          ğŸ‘¥ USERS
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Customers       â”‚
                    â”‚ Admins          â”‚
                    â”‚ Florists        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
              â–¼              â–¼              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Telegram â”‚  â”‚  Web App â”‚  â”‚  CRM API â”‚
        â”‚  Bot     â”‚  â”‚ (Shop)   â”‚  â”‚ (Bitrix) â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚              â”‚            â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  RAILWAY BACKEND              â”‚
            â”‚  REST API (147 endpoints)     â”‚
            â”‚  FastAPI â€¢ Python             â”‚
            â”‚                               â”‚
            â”‚  Core Operations:             â”‚
            â”‚  â”œâ”€ Product Management        â”‚
            â”‚  â”œâ”€ Order Tracking            â”‚
            â”‚  â”œâ”€ Payment Processing        â”‚
            â”‚  â”œâ”€ Delivery Coordination     â”‚
            â”‚  â”œâ”€ User Authentication       â”‚
            â”‚  â”œâ”€ AI Chat Conversations     â”‚
            â”‚  â””â”€ WEBHOOKS â­               â”‚
            â”‚     â”œâ”€ Bitrix Order Sync      â”‚
            â”‚     â”œâ”€ Bitrix Product Sync    â”‚
            â”‚     â””â”€ Other integrations     â”‚
            â”‚                               â”‚
            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚            â”‚      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”   â”‚
        â”‚PostgreSQL  â”‚Cloudflareâ”‚   â”‚
        â”‚Database    â”‚R2 Images â”‚   â”‚
        â”‚            â”‚CDN       â”‚   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”˜   â”‚
                             â”‚     â”‚
                             â–¼     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ Embedding   â”‚ â”‚
                    â”‚ Service     â”‚ â”‚
                    â”‚ (AI search) â”‚ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                    â”‚
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Bitrix CRM           â”‚
                    â”‚ (185.125.90.141)     â”‚
                    â”‚                      â”‚
                    â”‚ MySQL + PHP          â”‚
                    â”‚                      â”‚
                    â”‚ Data:                â”‚
                    â”‚ â”œâ”€ Products          â”‚
                    â”‚ â”œâ”€ Orders            â”‚
                    â”‚ â”œâ”€ Clients           â”‚
                    â”‚ â””â”€ History           â”‚
                    â”‚                      â”‚
                    â”‚ Synced with Railway: â”‚
                    â”‚ â”œâ”€ Order Status      â”‚
                    â”‚ â”œâ”€ Product Info      â”‚
                    â”‚ â””â”€ Inventory         â”‚
                    â”‚                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. DEPLOYMENT ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Developer commits to main branch                       â”‚
â”‚  git push origin main                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  GitHub detects change       â”‚
        â”‚  Sends webhook to Railway    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚             â”‚             â”‚
         â–¼             â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Backend â”‚  â”‚Frontendâ”‚  â”‚Database â”‚
    â”‚ Build   â”‚  â”‚ Build  â”‚  â”‚ (no     â”‚
    â”‚         â”‚  â”‚        â”‚  â”‚ change) â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚
         â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Nixpacks Auto-Detection  â”‚
    â”‚                          â”‚
    â”‚ Backend:                 â”‚
    â”‚ â”œâ”€ Detect: Python 3.10   â”‚
    â”‚ â”œâ”€ pip install -r req... â”‚
    â”‚ â”œâ”€ ./start.sh (main.py)  â”‚
    â”‚                          â”‚
    â”‚ Frontend:                â”‚
    â”‚ â”œâ”€ Detect: Node.js       â”‚
    â”‚ â”œâ”€ npm ci                â”‚
    â”‚ â”œâ”€ npm run build         â”‚
    â”‚ â”œâ”€ serve -s dist         â”‚
    â”‚                          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Health Check             â”‚
    â”‚ GET /health              â”‚
    â”‚                          â”‚
    â”‚ Expected: HTTP 200       â”‚
    â”‚ Database: healthy        â”‚
    â”‚ Services: ready          â”‚
    â”‚                          â”‚
    â”‚ âŒ If fails: Rollback!   â”‚
    â”‚ âœ… If OK: Continue       â”‚
    â”‚                          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Graceful Transition      â”‚
    â”‚                          â”‚
    â”‚ 1. New version starts    â”‚
    â”‚ 2. Both versions running â”‚
    â”‚ 3. Switch traffic â†’ New  â”‚
    â”‚ 4. Old version stops     â”‚
    â”‚                          â”‚
    â”‚ â±ï¸ Downtime: ~2 seconds  â”‚
    â”‚                          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ… LIVE IN PRODUCTION!   â”‚
    â”‚                          â”‚
    â”‚ URL: https://figma-...   â”‚
    â”‚ Uptime: 99.9%           â”‚
    â”‚                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. SECURITY & MULTI-TENANCY

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REQUEST COMES TO RAILWAY API                          â”‚
â”‚  (Any endpoint)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Extract JWT Token       â”‚
        â”‚  from Authorization      â”‚
        â”‚  header                  â”‚
        â”‚                          â”‚
        â”‚  Token includes:         â”‚
        â”‚  â”œâ”€ user_id: 1          â”‚
        â”‚  â”œâ”€ phone: 77015211545  â”‚
        â”‚  â”œâ”€ role: DIRECTOR      â”‚
        â”‚  â”œâ”€ shop_id: 8 or 17008 â”‚
        â”‚  â””â”€ exp: expiration     â”‚
        â”‚                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Verify Token Signature  â”‚
        â”‚  (SECRET_KEY)            â”‚
        â”‚                          â”‚
        â”‚  âœ… Valid â†’ Continue     â”‚
        â”‚  âŒ Invalid â†’ 401        â”‚
        â”‚                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Extract shop_id from    â”‚
        â”‚  JWT Token               â”‚
        â”‚                          â”‚
        â”‚  shop_id = 8 OR 17008    â”‚
        â”‚                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  APPLY SHOP FILTER TO ALL    â”‚
        â”‚  DATABASE QUERIES            â”‚
        â”‚                              â”‚
        â”‚  Pattern:                    â”‚
        â”‚  SELECT * FROM order         â”‚
        â”‚  WHERE shop_id = $shop_id    â”‚
        â”‚  (from JWT)                  â”‚
        â”‚                              â”‚
        â”‚  Result:                     â”‚
        â”‚  - User from shop #8         â”‚
        â”‚    sees ONLY shop #8 data   â”‚
        â”‚                              â”‚
        â”‚  - User from shop #17008     â”‚
        â”‚    sees ONLY shop #17008 dataâ”‚
        â”‚                              â”‚
        â”‚  âœ… Complete Isolation       â”‚
        â”‚                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Return Data             â”‚
        â”‚  (filtered & secured)    â”‚
        â”‚                          â”‚
        â”‚  HTTP 200 OK            â”‚
        â”‚                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


EXAMPLE: Two different users, same endpoint

User A (shop_id=8, Dev)          User B (shop_id=17008, Prod)
â”‚                                â”‚
â”œâ”€ GET /api/v1/orders/          â”œâ”€ GET /api/v1/orders/
â”‚  JWT: shop_id=8               â”‚  JWT: shop_id=17008
â”‚  â†“                            â”‚  â†“
â”‚  Query: WHERE shop_id=8       â”‚  Query: WHERE shop_id=17008
â”‚  â†“                            â”‚  â†“
â”‚  Result: 5 test orders        â”‚  Result: 542 production orders
â”‚  (from test shop)             â”‚  (from production shop)
â”‚                                â”‚
â””â”€ User A NEVER sees shop #17008 data
â””â”€ User B NEVER sees shop #8 data

âœ… Complete isolation = Multi-tenancy working!
```

---

## 7. WEBHOOK SECURITY FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BITRIX SENDS WEBHOOK REQUEST                                â”‚
â”‚  POST /api/v1/webhooks/order-status-sync                    â”‚
â”‚  X-Webhook-Secret: cvety-webhook-2025-secure-key            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  RAILWAY RECEIVES REQUEST               â”‚
    â”‚  RequestIDMiddleware (add request ID)   â”‚
    â”‚  PrometheusMiddleware (track metrics)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  FastAPI Route Handler                  â”‚
    â”‚  order_status_sync_webhook()            â”‚
    â”‚                                         â”‚
    â”‚  Parameters:                            â”‚
    â”‚  - payload: OrderStatusSyncPayload      â”‚
    â”‚  - session: AsyncSession (DB)           â”‚
    â”‚  - x_webhook_secret: str (header)       â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â­ SECURITY CHECK #1: Secret           â”‚
    â”‚                                         â”‚
    â”‚  if x_webhook_secret != WEBHOOK_SECRET: â”‚
    â”‚    raise HTTPException(401)             â”‚
    â”‚    logger.warning("Failed: invalid sec")â”‚
    â”‚    return                               â”‚
    â”‚                                         â”‚
    â”‚  âœ… Secret matches? Continue...         â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â­ SECURITY CHECK #2: Input Validation â”‚
    â”‚                                         â”‚
    â”‚  payload validated by Pydantic:        â”‚
    â”‚  - order_id: must be int               â”‚
    â”‚  - status: must be str                 â”‚
    â”‚  - changed_by_id: optional int         â”‚
    â”‚  - notes: optional str                 â”‚
    â”‚                                         â”‚
    â”‚  Invalid â†’ HTTPException(422)          â”‚
    â”‚  Valid â†’ Continue...                   â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â­ SECURITY CHECK #3: Database Filter  â”‚
    â”‚                                         â”‚
    â”‚  stmt = select(Order).where(            â”‚
    â”‚    Order.bitrix_order_id == payload.id â”‚
    â”‚    AND Order.shop_id == 17008           â”‚ â† Only prod!
    â”‚  )                                      â”‚
    â”‚                                         â”‚
    â”‚  Even if someone sends invalid data:   â”‚
    â”‚  - Dev shop (8) orders NOT touched     â”‚
    â”‚  - Only production (17008) processed   â”‚
    â”‚                                         â”‚
    â”‚  âœ… Shop isolation enforced             â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â­ SECURITY CHECK #4: Status Enum      â”‚
    â”‚                                         â”‚
    â”‚  railway_status = BX_TO_RAILWAY_STATUS  â”‚
    â”‚    .get(payload.status)                 â”‚
    â”‚                                         â”‚
    â”‚  If status unknown:                     â”‚
    â”‚    return {"status": "skipped"}         â”‚
    â”‚    (doesn't crash, just skips)          â”‚
    â”‚                                         â”‚
    â”‚  âœ… Enum validation prevents injection  â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  âœ… ALL SECURITY CHECKS PASSED          â”‚
    â”‚                                         â”‚
    â”‚  Safe to update database:               â”‚
    â”‚  - Secret verified âœ…                   â”‚
    â”‚  - Input validated âœ…                   â”‚
    â”‚  - Shop isolated âœ…                     â”‚
    â”‚  - Enum enforced âœ…                     â”‚
    â”‚                                         â”‚
    â”‚  Update order.status                    â”‚
    â”‚  Create order_history entry             â”‚
    â”‚  Commit transaction                     â”‚
    â”‚                                         â”‚
    â”‚  Return HTTP 200                        â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

THREAT MODEL COVERAGE:

âŒ Brute Force Attack
   â†’ Webhook secret is random, 32+ chars
   â†’ Even if guessed, Railway has rate limiting

âŒ SQL Injection
   â†’ All inputs go through Pydantic validation
   â†’ ORM (SQLModel) escapes all parameters
   â†’ No raw SQL queries

âŒ Unauthorized Access
   â†’ Secret MUST match exactly
   â†’ No bypasses or backdoors

âŒ Data Leakage
   â†’ shop_id filter ensures isolation
   â†’ Can't access other shop's data

âŒ Invalid Data
   â†’ Enum validation prevents bad statuses
   â†’ Status mapping is explicitly defined

âœ… SECURITY: EXCELLENT
```

---

## 8. ERROR HANDLING FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VARIOUS ERROR SCENARIOS & HOW THEY'RE HANDLED             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚             â”‚
        â–¼           â–¼           â–¼             â–¼
    Wrong      Order Not   Unknown      Bitrix
    Secret     Found        Status       Unavail
    â”‚          â”‚            â”‚           â”‚
    â”‚          â–¼            â–¼           â–¼
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚ Check error type                 â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                â”‚
    â”‚                â”œâ”€ Critical (auth fails)
    â”‚                â”‚  â””â”€ HTTP 401/403
    â”‚                â”‚  â””â”€ NO exception (safe)
    â”‚                â”‚
    â”‚                â”œâ”€ Non-Critical (order not found)
    â”‚                â”‚  â””â”€ HTTP 200 (skip)
    â”‚                â”‚  â””â”€ {"status": "skipped"}
    â”‚                â”‚
    â”‚                â””â”€ Sync Failures (Bitrix unreachable)
    â”‚                   â””â”€ Log error
    â”‚                   â””â”€ Don't block API
    â”‚                   â””â”€ Return success anyway
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GRACEFUL DEGRADATION               â”‚
â”‚                                     â”‚
â”‚  Example: Bitrix is down            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚                                     â”‚
â”‚  1. Admin updates product           â”‚
â”‚  2. Railway updates DB âœ…           â”‚
â”‚  3. Tries to sync to Bitrix âŒ down â”‚
â”‚  4. Catches exception               â”‚
â”‚  5. Logs: "Failed to sync..."       â”‚
â”‚  6. Returns HTTP 200 anyway! âœ…     â”‚
â”‚                                     â”‚
â”‚  Result:                            â”‚
â”‚  - Product updated in Railway âœ…    â”‚
â”‚  - API doesn't return error âœ…      â”‚
â”‚  - Bitrix syncs later (when up) â±ï¸  â”‚
â”‚  - No customer impact âœ…            â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. PERFORMANCE SUMMARY

```
REQUEST LATENCY BREAKDOWN (Webhook)

â”Œâ”€ Request comes in
â”‚  â””â”€ 0ms: Request received
â”‚
â”œâ”€ Authentication
â”‚  â””â”€ 2ms: Secret validation
â”‚
â”œâ”€ Input Validation
â”‚  â””â”€ 1ms: Pydantic validation
â”‚
â”œâ”€ Database Query
â”‚  â””â”€ 15ms: SELECT with index lookup
â”‚         (idx_order_bitrix_id)
â”‚
â”œâ”€ Status Mapping
â”‚  â””â”€ 1ms: Dict lookup (BX_TO_RAILWAY_STATUS)
â”‚
â”œâ”€ Update Orders
â”‚  â””â”€ 20ms: UPDATE "order" + INSERT history
â”‚
â”œâ”€ Logging
â”‚  â””â”€ 5ms: Structured logging
â”‚
â””â”€ Response
   â””â”€ 5ms: JSON serialization + HTTP

   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOTAL: ~49ms average âœ… Excellent!
   TARGET: <500ms
   ACTUAL: ~107-140ms (with network)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Database is KEY to performance:
â””â”€ Index on bitrix_order_id
   â””â”€ Lookup: O(1) = <5ms
   â””â”€ Without index: O(n) = could be 1000ms+

Network overhead:
â””â”€ Bitrix â†’ Railway: ~50ms
â””â”€ Response time: ~50ms
â””â”€ Total network: ~100ms

Math:
â”œâ”€ Database time: 45ms
â”œâ”€ Network time: 100ms
â”œâ”€ Code execution: 20ms
â””â”€ = 165ms average (matches observed 107-140ms) âœ…
```

---

**End of Diagrams**

Ğ’ÑĞµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾ Ğ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾! ğŸš€
