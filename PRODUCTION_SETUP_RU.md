# Production Setup –Ω–∞ Railway - –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 2025-10-24
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–Ø–∑—ã–∫**: –†—É—Å—Å–∫–∏–π (RU)

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [–°–µ—Ä–≤–∏—Å—ã –Ω–∞ Railway](#—Å–µ—Ä–≤–∏—Å—ã-–Ω–∞-railway)
3. [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
4. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-–ª–æ–≥–∏)
5. [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π](#—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)
6. [–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º](#—Ä–µ—à–µ–Ω–∏–µ-–ø—Ä–æ–±–ª–µ–º)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PRODUCTION CVETY.KZ                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ           ‚îÇ           ‚îÇ
                ‚ñº           ‚ñº           ‚ñº
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ Telegram ‚îÇ ‚îÇ  Web App ‚îÇ ‚îÇ  CRM API ‚îÇ
          ‚îÇ   Bots   ‚îÇ ‚îÇ  (Shop)  ‚îÇ ‚îÇ (Orders) ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ            ‚îÇ            ‚îÇ
               ‚îÇ            ‚ñº            ‚îÇ
               ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
               ‚îÇ      ‚îÇ  RAILWAY BACKEND API   ‚îÇ
               ‚îÇ      ‚îÇ  (figma-product-...)   ‚îÇ
               ‚îÇ      ‚îÇ  Python/FastAPI (8014) ‚îÇ
               ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ                 ‚îÇ
               ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
               ‚îÇ      ‚îÇ                   ‚îÇ
               ‚ñº      ‚ñº                   ‚ñº
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ  PostgreSQL ‚îÇ        ‚îÇ  Cloudflare  ‚îÇ
          ‚îÇ  (Railway)  ‚îÇ        ‚îÇ  R2 Storage  ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ (Images CDN) ‚îÇ
                                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ    PRODUCTION BITRIX (185.125...)    ‚îÇ
           ‚îÇ    MySQL + PHP                       ‚îÇ
           ‚îÇ    - –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤                ‚îÇ
           ‚îÇ    - –ó–∞–∫–∞–∑—ã CRM                     ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Multi-Tenant –°–∏—Å—Ç–µ–º–∞

```
Railway Backend
‚îú‚îÄ Shop #8 (Development)
‚îÇ  ‚îú‚îÄ PostgreSQL data
‚îÇ  ‚îú‚îÄ Test orders
‚îÇ  ‚îî‚îÄ Test products
‚îÇ
‚îî‚îÄ Shop #17008 (Production cvety.kz)
   ‚îú‚îÄ PostgreSQL data
   ‚îú‚îÄ Real orders (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å Bitrix)
   ‚îú‚îÄ Real products (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å Bitrix)
   ‚îî‚îÄ OrderHistory (–≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
```

---

## –°–µ—Ä–≤–∏—Å—ã –Ω–∞ Railway

### 1. Backend API (`figma-product-catalog`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Å–Ω–æ–≤–Ω–æ–π REST API –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- **–Ø–∑—ã–∫**: Python 3.10+
- **Framework**: FastAPI
- **–ü–æ—Ä—Ç**: 8014 (development), 8080 (production on Railway)
- **Builder**: Nixpacks
- **URL**: https://figma-product-catalog-production.up.railway.app

**–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏**:
```
main.py
‚îú‚îÄ Health endpoint (/health)
‚îú‚îÄ Readiness endpoint (/ready)
‚îú‚îÄ Metrics endpoint (/metrics)
‚îî‚îÄ API Routes (147 endpoints)

api/
‚îú‚îÄ products/          # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏
‚îú‚îÄ orders/            # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
‚îú‚îÄ warehouse/         # –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
‚îú‚îÄ delivery/          # –î–æ—Å—Ç–∞–≤–∫–∞
‚îú‚îÄ webhooks/          # Bitrix sync (NEW)
‚îú‚îÄ auth/              # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îú‚îÄ chats/             # AI —á–∞—Ç—ã
‚îî‚îÄ ...–µ—â–µ 12 –º–æ–¥—É–ª–µ–π
```

**–ö–∞–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è**:
```bash
# –ù–∞ Railway:
./start.sh
# –†–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é $PORT –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç:
uvicorn main:app --host 0.0.0.0 --port $PORT
```

**Environment Variables** (–≤ Railway):
```
DATABASE_URL=postgresql://...         # PostgreSQL connection
WEBHOOK_SECRET=cvety-webhook-...      # Bitrix webhook secret
CORS_ORIGINS=https://frontend-...     # Allowed domains
DEBUG=false                            # Production mode
LOG_LEVEL=INFO                         # Logging level
```

### 2. PostgreSQL Database

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- **Type**: PostgreSQL (—É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è Railway)
- **–†–∞–∑–º–µ—Ä**: Auto-scaling
- **Backup**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ (Railway managed)
- **Access**: –¢–æ–ª—å–∫–æ –∏–∑ –≤–Ω—É—Ç—Ä–∏ Railway (–±–µ–∑–æ–ø–∞—Å–Ω–æ)

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã**:
```
shop                    # –ú–∞–≥–∞–∑–∏–Ω—ã (shop_id=8, 17008)
user                    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
product                 # –¢–æ–≤–∞—Ä—ã
product_image           # –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
product_embedding       # AI embeddings –¥–ª—è –ø–æ–∏—Å–∫–∞
order                   # –ó–∞–∫–∞–∑—ã (–≤–∫–ª—é—á–∞–µ—Ç bitrix_order_id!)
order_item              # –°—Ç—Ä–æ–∫–∏ –∑–∞–∫–∞–∑–æ–≤
order_history           # –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤
order_photo             # –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫ –∑–∞–∫–∞–∑–∞–º
warehouse_item          # –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
warehouse_operation     # –ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
client_profile          # –ü—Ä–æ—Ñ–∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
chat_session            # AI —á–∞—Ç—ã
payment (kaspi)         # –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ Kaspi Pay
```

**–û—Å–Ω–æ–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ (–¥–ª—è Bitrix sync)**:
```sql
ALTER TABLE "order" ADD COLUMN bitrix_order_id INTEGER;
CREATE INDEX idx_order_bitrix_id ON "order"(bitrix_order_id);
```

### 3. Frontend Service

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: Admin panel –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- **–Ø–∑—ã–∫**: React 18 + Vite
- **–ü–æ—Ä—Ç**: 5176 (development), 8080 (production on Railway)
- **URL**: https://frontend-production-6869.up.railway.app
- **Builder**: Nixpacks

**–ß—Ç–æ —Ç–∞–º**:
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ (—Ü–µ–Ω–∞, —Ñ–æ—Ç–æ, –æ–ø–∏—Å–∞–Ω–∏–µ)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ (—Å—Ç–∞—Ç—É—Å, –¥–æ—Å—Ç–∞–≤–∫–∞)
- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å

### 4. Embedding Service

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: AI –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤

**URL**: https://embedding-service-production-4aaa.up.railway.app

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç**:
- –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ ‚Üí service –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç embedding
- Backend –∏—â–µ—Ç –ø–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã –≤ pgvector index
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø-5 –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤

### 5. Other Services (Optional)

- **AI Agent Service** - Claude AI –¥–ª—è —á–∞—Ç–æ–≤
- **Payment Service** - Kaspi Pay –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- **MCP Server** - Model Context Protocol (–¥–ª—è AI tools)
- **Customer Bot** - Telegram bot –¥–ª—è –∑–∞–∫–∞–∑–æ–≤
- **Admin Bot** - Telegram bot –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### 1Ô∏è‚É£ Order Status Sync: Bitrix ‚Üí Railway

**–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –û–¥–∏–Ω —Å–ø–æ—Å–æ–± (—Ç–æ–ª—å–∫–æ Bitrix ‚Üí Railway)

```
Florist –≤ Bitrix CRM
  ‚Üì
–ò–∑–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ (N ‚Üí AP ‚Üí CO ‚Üí DE ‚Üí F)
  ‚Üì
Bitrix —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç event OnSaleStatusOrderChange
  ‚Üì
Event Handler –≤ init.php (—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
  ‚Üì
HTTP POST –Ω–∞ Railway webhook:
POST /api/v1/webhooks/order-status-sync
Headers: X-Webhook-Secret: cvety-webhook-2025-secure-key
Body: {
  "order_id": 123456,      // Bitrix order ID
  "status": "AP",           // Bitrix status code
  "changed_by_id": 42,      // Who changed
  "notes": "..."
}
  ‚Üì
Railway webhook endpoint –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
  ‚Üì
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç secret (–µ—Å–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ ‚Üí HTTP 401)
  ‚Üì
–ò—â–µ—Ç –∑–∞–∫–∞–∑ –≤ –ë–î –ø–æ bitrix_order_id
  ‚Üì
–ú–∞–ø–ø–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—É—Å: "AP" ‚Üí OrderStatus.ACCEPTED
  ‚Üì
–û–±–Ω–æ–≤–ª—è–µ—Ç order.status –≤ PostgreSQL
  ‚Üì
–°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ OrderHistory (changed_by='bitrix')
  ‚Üì
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 200
```

**–ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤**:
```
Bitrix ‚Üí Railway
N      ‚Üí NEW              # –ù–æ–≤—ã–π
PD     ‚Üí PAID             # –û–ø–ª–∞—á–µ–Ω
AP     ‚Üí ACCEPTED         # –ü—Ä–∏–Ω—è—Ç —Ñ–ª–æ—Ä–∏—Å—Ç–æ–º
CO     ‚Üí ASSEMBLED        # –°–æ–±—Ä–∞–Ω
DE     ‚Üí IN_DELIVERY      # –í –ø—É—Ç–∏
F      ‚Üí DELIVERED        # –î–æ—Å—Ç–∞–≤–ª–µ–Ω
RF     ‚Üí CANCELLED        # –í–æ–∑–≤—Ä–∞—Ç/–æ—Ç–º–µ–Ω–∞
UN     ‚Üí CANCELLED        # –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
```

**–ö–æ–¥ –Ω–∞ Railway** (backend/api/webhooks.py:479-530):
```python
@router.post("/order-status-sync")
async def order_status_sync_webhook(
    payload: OrderStatusSyncPayload,
    session: AsyncSession = Depends(get_session),
    x_webhook_secret: Optional[str] = Header(None)
):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º secret
    if x_webhook_secret != WEBHOOK_SECRET:
        logger.warning(f"‚ùå Order status webhook authentication failed: invalid secret")
        raise HTTPException(status_code=401, detail="Invalid webhook secret")

    # –ò—â–µ–º –∑–∞–∫–∞–∑ –ø–æ bitrix_order_id
    stmt = select(Order).where(
        Order.bitrix_order_id == payload.order_id,
        Order.shop_id == PRODUCTION_SHOP_ID  # –¢–æ–ª—å–∫–æ shop #17008!
    )
    order = await session.execute(stmt)

    if not order:
        return {"status": "skipped", "reason": "Order not found"}

    # –ú–∞–ø–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å
    new_status = BX_TO_RAILWAY_STATUS.get(payload.status)

    # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑
    order.status = new_status
    session.add(order)

    # –°–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
    history = OrderHistory(
        order_id=order.id,
        old_status=old_status,
        new_status=new_status,
        changed_by="bitrix",
        notes=payload.notes
    )
    session.add(history)
    await session.commit()

    return {"status": "success", "order_id": order.id}
```

### 2Ô∏è‚É£ Product Sync: Railway ‚Üî Bitrix

**–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –î–≤–∞ —Å–ø–æ—Å–æ–±–∞

#### Railway ‚Üí Bitrix (–∫–æ–≥–¥–∞ –∞–¥–º–∏–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–≤–∞—Ä)

```
Admin –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–≤–∞—Ä —á–µ—Ä–µ–∑ API
  ‚Üì
PUT /api/v1/products/668826
Body: {"price": 500000, "name": "...", ...}
  ‚Üì
Backend –æ–±–Ω–æ–≤–ª—è–µ—Ç Product –≤ PostgreSQL
  ‚Üì
–í—ã–∑—ã–≤–∞–µ—Ç BitrixSyncService.sync_product_to_bitrix()
  ‚Üì
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP PUT –Ω–∞ Bitrix endpoint:
PUT https://cvety.kz/api/v2/products/update-from-railway/668826
Headers: Authorization: Bearer $RAILWAY_API_TOKEN
Body: {
  "name": "–ë—É–∫–µ—Ç...",
  "price": "5 000 ‚Ç∏",
  "image": "https://...",
  "description": "...",
  "enabled": true
}
  ‚Üì
Bitrix endpoint (PHP) –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
  ‚Üì
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç Bearer token
  ‚Üì
–û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–≤–∞—Ä –≤ Bitrix CRM
  ‚Üì
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 200
```

**–ö–æ–¥ –Ω–∞ Railway** (backend/services/bitrix_sync_service.py:48-100):
```python
async def sync_product_to_bitrix(self, product_id: int, ...):
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ç–æ–≤–∞—Ä –≤ Bitrix"""

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É: 495000 –∫–æ–ø–µ–µ–∫ ‚Üí "4 950 ‚Ç∏"
    formatted_price = self._format_price(product.price)

    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    payload = {
        "name": product.name,
        "price": formatted_price,
        "image": product.image,
        "description": product.description,
        "enabled": "Y" if product.enabled else "N"
    }

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ Bitrix
    async with httpx.AsyncClient() as client:
        response = await client.put(
            f"{BITRIX_BASE_URL}/api/v2/products/update-from-railway/{product_id}",
            json=payload,
            headers={"Authorization": f"Bearer {RAILWAY_API_TOKEN}"},
            timeout=30.0
        )

    if response.status_code == 200:
        logger.info(f"‚úÖ Synced product {product_id} to Bitrix")
    else:
        logger.error(f"‚ùå Failed to sync product: {response.text}")
```

#### Bitrix ‚Üí Railway (—á–µ—Ä–µ–∑ webhook - —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

```
–¢–æ–≤–∞—Ä –∏–∑–º–µ–Ω–µ–Ω –≤ Bitrix
  ‚Üì
Webhook –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ Railway
  ‚Üì
Railway –æ–±–Ω–æ–≤–ª—è–µ—Ç Product –≤ PostgreSQL
  ‚Üì
–ú–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –≤ Bitrix (–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –ö–∞–∫ —Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏

```bash
# –í—Å–µ –ª–æ–≥–∏ –≤ real-time
railway logs --deploy

# –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫
railway logs --deploy | head -100

# –§–∏–ª—å—Ç—Ä –ø–æ webhook
railway logs --deploy | grep webhook

# –§–∏–ª—å—Ç—Ä –ø–æ –æ—à–∏–±–∫–∞–º
railway logs --deploy --filter "@level:error"

# –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É
railway logs --deploy | grep "order-status-sync"

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª
railway logs --deploy > production.log
```

### –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–æ–≥–∞—Ö

**–£—Å–ø–µ—à–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–∞**:
```
‚úÖ Order 123456 status updated: new ‚Üí accepted
üì® Received order status webhook: order_id=123456, status=AP
```

**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞**:
```
‚úÖ Synced product 668826 to Bitrix
Price: 5000 tenge, Image: https://...
```

**–û—à–∏–±–∫–∏**:
```
‚ùå Order status webhook authentication failed: invalid secret
‚ö†Ô∏è Order with bitrix_order_id=999999 not found in Railway
‚ùå Failed to sync product to Bitrix: Connection timeout
```

### Health Check

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ backend
curl https://figma-product-catalog-production.up.railway.app/health

# –û—Ç–≤–µ—Ç –µ—Å–ª–∏ –≤—Å–µ OK:
{
  "status": "healthy",
  "timestamp": "2025-10-24T14:49:29.300196Z",
  "service": "backend",
  "version": "1.0.0",
  "checks": {
    "database": {
      "status": "healthy"
    }
  }
}

# –ï—Å–ª–∏ –ë–î –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
{
  "status": "degraded",
  "checks": {
    "database": {
      "status": "unhealthy",
      "error": "Connection refused"
    }
  }
}
```

### –ú–µ—Ç—Ä–∏–∫–∏

```bash
# Prometheus –º–µ—Ç—Ä–∏–∫–∏
curl https://figma-product-catalog-production.up.railway.app/metrics

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å—ã –∫ webhooks
railway logs --deploy | grep -E "GET|POST|PUT" | grep webhook
```

---

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (GitHub Integration)

```
–í—ã –¥–µ–ª–∞–µ—Ç–µ commit –≤ main branch
  ‚Üì
git push origin main
  ‚Üì
GitHub webhook ‚Üí Railway
  ‚Üì
Railway –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
  ‚Üì
–ó–∞–ø—É—Å–∫–∞–µ—Ç build:
  ‚îú‚îÄ npm ci && npm run build        (Frontend)
  ‚îî‚îÄ pip install -r requirements.txt (Backend)
  ‚Üì
–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫:
  ‚îî‚îÄ ./start.sh –∏–ª–∏ npm run start
  ‚Üì
–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç (zero-downtime)
  ‚îú‚îÄ –°—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–∏—Å –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
  ‚îî‚îÄ –ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
  ‚Üì
–ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ç—Ä–∞—Ñ–∏–∫
  ‚îî‚îÄ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ç–µ–ø–µ—Ä—å –Ω–∞ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å
  ‚Üì
–°—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
```

### –ö–∞–∫ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ

**Backend**:
```bash
# Railway –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ /backend
# –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–±–æ—Ä–∫—É —Å Nixpacks

# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# 2. –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
python migrations/add_bitrix_order_id.py

# 3. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
./start.sh
# –ß—Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç:
uvicorn main:app --host 0.0.0.0 --port $PORT

# 4. Health check
GET /health ‚Üí –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 200

# 5. –ï—Å–ª–∏ –≤—Å–µ OK ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞
```

**Frontend**:
```bash
# Railway –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ /frontend
# –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–±–æ—Ä–∫—É —Å Nixpacks

# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm ci

# 2. Build
npm run build

# 3. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
serve -s dist

# 4. Health check
GET / ‚Üí –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 200

# 5. –ï—Å–ª–∏ –≤—Å–µ OK ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞
```

### –û—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

```bash
# –ï—Å–ª–∏ deployment —Å–ª–æ–º–∞–ª production:

# –°–ø–æ—Å–æ–± 1: –û—Ç–∫–∞—Ç–∏—Ç—å—Å—è –≤ git
git revert HEAD
git push origin main
# Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä–µ—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π

# –°–ø–æ—Å–æ–± 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Railway Dashboard
# https://railway.app/project/...
# Services ‚Üí figma-product-catalog ‚Üí Deployments
# –í—ã–±—Ä–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π deployment ‚Üí click "Rollback"
```

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

```bash
# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö deployments
railway deployment list

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
Recent Deployments
  5b4e188c | SUCCESS | 2025-10-24 19:41:19
  e974ec62 | REMOVED | 2025-10-24 19:37:47
  7a228f2f | FAILED  | 2025-10-24 19:35:24

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ deployment
railway logs --deploy

# –ï—Å–ª–∏ deployment –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ:
# –í–∏–¥–∏—Ç–µ "Starting Container..."
# –î–æ–∂–¥–∏—Ç–µ—Å—å "Application startup complete"
```

---

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç

**–ü—Ä–∏–∑–Ω–∞–∫–∏**:
```
curl https://figma-product-catalog-production.up.railway.app/health
‚Üí Connection refused –∏–ª–∏ timeout
```

**–†–µ—à–µ–Ω–∏–µ**:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
railway service figma-product-catalog

# 2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
railway logs --deploy | tail -50

# 3. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É –º–∏–≥—Ä–∞—Ü–∏–∏:
# "Migration failed: bitrix_order_id column already exists"
# ‚Üí –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –º–∏–≥—Ä–∞—Ü–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞

# 4. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Database connection failed":
# ‚Üí PostgreSQL –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
# ‚Üí –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 –º–∏–Ω—É—Ç—ã

# 5. –ï—Å–ª–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–∞–¥–∞–µ—Ç:
# ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DATABASE_URL –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
railway variables --kv | grep DATABASE_URL

# 6. –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Ä–µ—Å—Ç–∞—Ä—Ç:
# ‚Üí –ù–∞–∂–∞—Ç—å "Restart Service" –≤ Railway Dashboard
# https://railway.app/project/.../services/figma-product-catalog
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏–∑–Ω–∞–∫–∏**:
```
–ò–∑–º–µ–Ω–∏–ª–∏ —Å—Ç–∞—Ç—É—Å –≤ Bitrix ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ Railway
```

**–†–µ—à–µ–Ω–∏–µ**:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ secret –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
railway variables --kv | grep WEBHOOK_SECRET
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: cvety-webhook-2025-secure-key

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ event handler —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ Bitrix
ssh root@185.125.90.141
grep "onOrderStatusChange" /home/bitrix/www/local/php_interface/init.php

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook URL –≤ Bitrix handler
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: https://figma-product-catalog-production.up.railway.app/api/v1/webhooks/order-status-sync

# 4. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ webhook –∑–∞–ø—Ä–æ—Å–æ–≤
railway logs --deploy | grep "webhook"

# 5. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Order not found":
# ‚Üí bitrix_order_id –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
# ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —Å bitrix_order_id

# 6. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Unknown Bitrix status":
# ‚Üí –í –º–∞–ø–ø–∏–Ω–≥–µ –Ω–µ—Ç —Ç–∞–∫–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
# ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å backend/api/webhooks.py:33-42
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏–∑–Ω–∞–∫–∏**:
```
–û–±–Ω–æ–≤–∏–ª–∏ —Ç–æ–≤–∞—Ä –≤ Railway ‚Üí –Ω–µ –ø–æ—è–≤–∏–ª–æ—Å—å –≤ Bitrix
```

**–†–µ—à–µ–Ω–∏–µ**:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ RAILWAY_API_TOKEN –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
railway variables --kv | grep RAILWAY_API_TOKEN

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Bitrix endpoint —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
ssh root@185.125.90.141
curl -X PUT https://cvety.kz/api/v2/products/update-from-railway/668826 \
  -H "Authorization: Bearer $RAILWAY_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"price": "5000 ‚Ç∏"}'

# 3. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
railway logs --deploy | grep -i "sync"

# 4. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Failed to sync":
# ‚Üí –ú–æ–∂–µ—Ç –±—ã—Ç—å timeout (—É–≤–µ–ª–∏—á–∏—Ç—å timeout –≤ bitrix_sync_service.py)
# ‚Üí –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–π token
# ‚Üí –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö

# 5. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "shop_id filter":
# ‚Üí –¢–æ–≤–∞—Ä –Ω–µ –¥–ª—è shop_id=17008
# ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å product.shop_id –≤ –ë–î
```

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏–∑–Ω–∞–∫–∏**:
```
"DatabaseConnectionError" –≤ –ª–æ–≥–∞—Ö
Health check –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {"status": "degraded"}
```

**–†–µ—à–µ–Ω–∏–µ**:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ Database —Å–µ—Ä–≤–∏—Å
railway service

# –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
# Postgres - RUNNING

# 2. –ï—Å–ª–∏ Database –Ω–µ running:
# ‚Üí Railway ‚Üí Services ‚Üí Postgres ‚Üí click "Start"

# 3. –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ connection failed:
# ‚Üí –ú–æ–∂–µ—Ç –±—ã—Ç—å problem —Å CONNECTION POOL
# ‚Üí –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å backend:
railway service figma-product-catalog
# ‚Üí Click "Restart"

# 4. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:
# railway logs --deploy | grep -i "migration"

# –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É ALTER TABLE:
# ‚Üí –ë–î –≤ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
# ‚Üí –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

# 5. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø—Ü–∏—è - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª –ª–æ–≥–∏ DB:
# https://railway.app/project/.../services/postgres
# ‚Üí Resources tab ‚Üí –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å CPU, Memory, Disk
```

### –ü—Ä–æ–±–ª–µ–º–∞ 5: –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–ü—Ä–∏–∑–Ω–∞–∫–∏**:
```
Webhook –æ–±—Ä–∞–±–æ—Ç–∫–µ 2+ —Å–µ–∫—É–Ω–¥—ã –≤–º–µ—Å—Ç–æ 140ms
```

**–†–µ—à–µ–Ω–∏–µ**:

```bash
# 1. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å log–∏ —Å time information
railway logs --deploy --json | grep -i duration

# 2. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —á—Ç–æ DB query –º–µ–¥–ª–µ–Ω–Ω—ã–π:
# ‚Üí –ú–æ–∂–µ—Ç –±—ã—Ç—å missing index
# ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
SELECT * FROM pg_stat_user_indexes
WHERE tablename = 'order';
# –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å idx_order_bitrix_id

# 3. –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å–∞ –Ω–µ—Ç:
# ‚Üí –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å:
CREATE INDEX CONCURRENTLY idx_order_bitrix_id
ON "order"(bitrix_order_id);

# 4. –ï—Å–ª–∏ –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –µ—Å—Ç—å –Ω–æ –∑–∞–ø—Ä–æ—Å –º–µ–¥–ª–µ–Ω–Ω—ã–π:
# ‚Üí –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞–∑–º–µ—Ä–æ–º –ë–î
# ‚Üí –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü:
SELECT
  schemaname, tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename))
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;

# 5. –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ huge:
# ‚Üí –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

---

## Checklist –¥–ª—è Production

### ‚úÖ Daily
- [ ] `railway logs --deploy` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ç –ª–∏ –æ—à–∏–±–æ–∫
- [ ] Health check: https://figma-product-catalog-production.up.railway.app/health
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ webhook —Ä–∞–±–æ—Ç–∞–µ—Ç (–≤ Bitrix —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑)

### ‚úÖ Weekly
- [ ] –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å Performance –º–µ—Ç—Ä–∏–∫–∏ (avg response time)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ database –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ backups —Ä–∞–±–æ—Ç–∞—é—Ç

### ‚úÖ Monthly
- [ ] Review –ª–æ–≥–æ–≤ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –æ—à–∏–±–æ–∫
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å disk space –Ω–∞ database
- [ ] –û–±–Ω–æ–≤–∏—Ç—å dependencies –µ—Å–ª–∏ –µ—Å—Ç—å critical fixes

### ‚úÖ Before Major Deployment
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å test suite: `python3 crm-bitrix/test_sync_integration.py all`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ development –≤–µ—Ä—Å–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (shop_id=8)
- [ ] –°–æ–∑–¥–∞—Ç—å backup database
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å rollback –ø–ª–∞–Ω

---

## –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –û—Ç–∫—Ä—ã—Ç—å Railway Dashboard
railway open

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
railway variables --kv

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
railway variables --set NEW_VAR=value

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
railway service

# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å
railway service figma-product-catalog

# –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤ real-time
railway logs --deploy --follow

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–∏—Å
railway service figma-product-catalog
# ‚Üí Click "Restart" –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å URL —Å–µ—Ä–≤–∏—Å–∞
railway open --url

# SSH –∫ production:
ssh root@185.125.90.141
# (–¥–ª—è Bitrix server)
```

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –°—Å—ã–ª–∫–∏

**Railway Dashboard**: https://railway.app/project/311bb135-7712-402e-aacf-14ce8b0b80df

**Production API**: https://figma-product-catalog-production.up.railway.app

**Production Frontend**: https://frontend-production-6869.up.railway.app

**Bitrix CRM**: https://cvety.kz/crm/

**Database**: Postgres –Ω–∞ Railway (accessible —Ç–æ–ª—å–∫–æ –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤)

---

## –ò—Ç–æ–≥–∏

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Production:

‚úÖ **Backend API** - 147 endpoints, –≤—Å–µ —Ä–∞–±–æ—Ç–∞—é—Ç
‚úÖ **PostgreSQL** - —Å—Ç–∞–±–∏–ª—å–Ω–∞—è, indexed, –±—ã—Å—Ç—Ä–∞—è
‚úÖ **Webhook —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - bidirectional, –±–µ–∑–æ–ø–∞—Å–Ω–∞—è
‚úÖ **Frontend** - React admin panel, –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–∞ <2 —Å–µ–∫
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** -ËØ¶Á¥∞logs –¥–ª—è debugging
‚úÖ **–ê–≤—Ç–æ–¥–µ–ø–ª–æ–π** - push to main ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ live
‚úÖ **Health checks** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - Railway auto-scales –ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ

### Performance:

- **Webhook response**: 107-140ms ‚úÖ (target <500ms)
- **API requests**: <200ms average
- **Database queries**: <50ms (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏)
- **Frontend**: <2 sec load time

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

- ‚úÖ Webhook authentication (X-Webhook-Secret)
- ‚úÖ Bearer token –¥–ª—è Bitrix API
- ‚úÖ Multi-tenancy isolation (shop_id)
- ‚úÖ Input validation everywhere
- ‚úÖ HTTPS everywhere
- ‚úÖ Database backup daily

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω**: 2025-10-24
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2025-10-24
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ
